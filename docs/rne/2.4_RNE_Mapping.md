# 2.4 – Mapping Source → Cible (RNE)

## 1. Objectif
Documenter comment les champs JSON fournis par le RNE sont transformés, normalisés et injectés dans les tables SQLite du fichier `rne.db`.

Ce document se base uniquement sur le mapping réellement implémenté dans les fonctions `map_rne_company_to_ul`, `map_rne_siege_to_ul`, `map_rne_dirigeant_pp_to_ul`, `map_rne_dirigeant_pm_to_ul`, `process_rne.py` et les modèles Pydantic.  
Il couvre exclusivement la partie RNE (pas SIRENE).

---

## 2. Logique générale
- **Parsing JSON** via les modèles Pydantic RNE.
- **Validation** des champs (types, présence, formats date).
- **Normalisation** :
  - nettoyage des chaînes,
  - construction des adresses,
  - priorisation de certains champs (forme juridique, radiation…),
  - sérialisation JSON pour les champs composites.
- **Injection dans SQLite** :
  - une ligne par UL / siège / établissement / dirigeant / activité,
  - propagation de `updatedAt` dans `date_mise_a_jour`,
  - traçabilité via `file_name`.

---

## 3. Tables concernées
Les tables alimentées dans `rne.db` sont :

- `unite_legale`
- `siege`
- `etablissement`
- `activite`
- `immatriculation`
- `dirigeant_pp`
- `dirigeant_pm`

Ces tables sont exactement celles décrites dans le fichier de mapping source → cible :contentReference[oaicite:1]{index=1}.

---

## 4. Mapping détaillé par table

---

### **4.1 unite_legale**

Mapping complet conforme au tableau 3.1 du fichier de référence :contentReference[oaicite:2]{index=2}.

Principes :
- `siren` → clé principale.
- Forme juridique dérivée via `get_forme_juridique`.
- Adresses formatées via `format_address()`.
- Règles de priorité pour : `date_creation`, `nature_juridique`, `etat_administratif`.
- Propagation systématique de `updatedAt` dans `date_mise_a_jour`.
- Champs non utilisés explicitement listés en fin de document (origin, codeAPE…).

---

### **4.2 siege**

Mapping conforme au tableau 3.2 du document de référence :contentReference[oaicite:3]{index=3}.

Points clés :
- `siret` de l’établissement principal.
- Mapping champ à champ de l’adresse (pays, commune, code postal, voie, type voie…).
- Signalétique (`enseigne`, `nom_commercial`).
- Date de mise à jour = `updatedAt`.
- Une ligne par siège.

---

### **4.3 etablissement**

Points clés (cf. tableau 3.2) :contentReference[oaicite:4]{index=4} :
- Un enregistrement par établissement secondaire (`autresEtablissements[]`).
- Colonnes minimales : `siren`, `siret`, `date_mise_a_jour`, `file_name`.
- Les adresses secondaires ne sont pas reprises (champ ignoré).

---

### **4.4 activite**

Mapping conforme (réf. tableau 3.2) :contentReference[oaicite:5]{index=5}.

Principes :
- Une ligne par activité, qu’elle provienne du siège ou d’un établissement.
- Champs : `code_category`, `code_ape`, `date_debut`, `form_exercice`, `categorisation_1/2/3`, indicateurs booléens.
- SIRET = celui du siège ou de l’établissement d’origine.
- Date mise à jour = `updatedAt`.

---

### **4.5 immatriculation**

Mapping conforme au tableau 3.4 :contentReference[oaicite:6]{index=6}.

Points importants :
- Copie directe de la plupart des champs : dates, capital, devise, durée.
- `date_radiation` = première date non nulle parmi (radiation > effet > cessation).
- `nature_entreprise` = liste JSON sérialisée issue des activités principales.
- Booléens sérialisés en texte (`indicateur_associe_unique`, `capital_variable`).

---

### **4.6 dirigeant_pp**

Mapping conforme au tableau 3.3 (partie individus) :contentReference[oaicite:7]{index=7}.

Principes :
- Dirigeants issus de `composition.pouvoirs[]` où `typeDePersonne == "INDIVIDU"`.
- Copie de l'identité complète : nom, nom_usage, prénoms (jointure espace), genre, date de naissance, nationalité, situation matrimoniale.
- `role` = `roleEntreprise`.
- Un entrepreneur individuel (“personne physique sans composition”) est inséré comme PP avec rôle vide.

---

### **4.7 dirigeant_pm**

Mapping conforme au tableau 3.3 (partie entreprises) :contentReference[oaicite:8]{index=8}.

Points clés :
- `siren_dirigeant` nettoyé (suppression espaces).
- Champs copiés : dénomination, pays, forme juridique.
- Rôle = `roleEntreprise`.

---

## 5. Points d’attention

Basés sur la liste finale du fichier de mapping (section *Champs JSON non utilisés / ignorés*) :contentReference[oaicite:9]{index=9} :

- Certains champs JSON **existent mais ne sont jamais utilisés** :
  - `origin`, `formality.companyName`, `formality.codeAPE`,  
  - `identite.entreprise.codeApe`,  
  - adresses personnelles des dirigeants,  
  - libellés de rôles (`libelleRoleEntreprise`),  
  - indicateurs de création (`entrepriseAgricole`, `societeEtrangere`), etc.

- Les adresses des **autres établissements** sont ignorées (seuls les SIRET sont repris).

- Le mapping à plusieurs sources peut produire des cas incohérents si les dates ou les formes juridiques sont divergentes entre blocs JSON.

- `nature_entreprise` dépend d’un set multi-sources :  
  → absence totale possible si aucune activité ne porte l’indicateur principal.

- Tous les `bool` deviennent des `TEXT` dans SQLite.

- `prenoms[]` est aplati en une seule chaîne concaténée.

---

## 6. Résumé
- Toutes les colonnes SQLite et leur origine JSON sont décrites.  
- Le mapping couvre UL, siège, établissements, activités, dirigeants PP/PM et immatriculation.  
- Les champs non utilisés sont explicitement identifiés pour audit futur.  
- La logique est strictement alignée avec le fichier de référence présent dans le dépôt.  
